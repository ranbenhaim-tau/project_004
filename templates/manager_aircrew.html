{% extends "base.html" %}
{% block content %}

<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-3">
  <div>
    <h2 class="mb-1">Aircrew</h2>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-success" href="{{ url_for('manager_aircrew_add') }}"><i class="bi bi-plus-lg me-1"></i>Add crew member</a>
    <a class="btn btn-outline-secondary" href="{{ url_for('manager_dashboard') }}"><i class="bi bi-house me-1"></i>Back to dashboard</a>
  </div>
</div>
<div class="card mb-3">
  <div class="card-body">
    <form class="row g-3 align-items-end" onsubmit="return false;">
  <div class="col-sm-6 col-md-2">
    <label class="form-label">Crew ID</label>
    <input id="flt-crew-id" type="text" class="form-control" placeholder="e.g., 9001">
    <div id="flt-crew-id-err" class="form-text text-danger d-none">Crew ID must be a whole number.</div>
  </div>
  <div class="col-sm-6 col-md-4">
    <label class="form-label">Name</label>
    <input id="flt-crew-name" type="text" class="form-control" placeholder="first or last name">
  </div>
  <div class="col-sm-6 col-md-3">
    <label class="form-label">Role</label>
    <select id="flt-crew-role" class="form-select">
      <option value="" selected>All</option>
      <option value="Pilot">Pilot</option>
      <option value="Flight attendant">Flight attendant</option>
    </select>
  </div>
  <div class="col-sm-6 col-md-2">
    <label class="form-label">Long-haul certified</label>
    <select id="flt-crew-training" class="form-select">
      <option value="" selected>All</option>
      <option value="1">Yes</option>
      <option value="0">No</option>
    </select>
  </div>
  <div class="col-sm-6 col-md-1 d-flex gap-2">
    <button id="flt-crew-clear" type="button" class="btn btn-outline-secondary w-100" title="Clear"><i class="bi bi-x-lg"></i></button>
  </div>
</form>

  </div>
</div>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Crew ID</th>
            <th>Role</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Address</th>
            <th class="text-nowrap">Long-haul certified</th>
          </tr>
        </thead>
        <tbody>
          {% for a in aircrew %}
            <tr data-crew-row='1'
                data-crew-id='{{ a.ID }}'
                data-crew-type='{{ a.Type }}'
                data-crew-name='{{ a.First_name }} {{ a.Last_name }}'
                data-crew-training='{{ a.Training }}'>
              <td class="fw-semibold text-nowrap">{{ a.ID }}</td>
              <td class="text-nowrap">{{ a.Type }}</td>
              <td>{{ a.First_name }} {{ a.Last_name }}</td>
              <td class="text-nowrap">{{ a.Phone_number }}</td>
              <td>{{ a.City }}, {{ a.Street }} {{ a.House_Number }}</td>
              <td class="text-nowrap">
                {% if a.Training in [1, '1', True] %}
                  <span class="badge bg-success text-white training-flag" title="Certified"><i class="bi bi-check-lg"></i></span>
                {% else %}
                  <span class="badge bg-danger text-white training-flag" title="Not certified"><i class="bi bi-x-lg"></i></span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          {% if not aircrew %}
            <tr><td colspan="6" class="text-center text-muted p-4">No crew members found.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<script>
(function(){
  const idEl = document.getElementById("flt-crew-id");
  const nameEl = document.getElementById("flt-crew-name");
  const roleEl = document.getElementById("flt-crew-role");
  const trEl = document.getElementById("flt-crew-training");
  const errEl = document.getElementById("flt-crew-id-err");
  const rows = Array.from(document.querySelectorAll("tr[data-crew-row='1']"));

  function normalize(s){ return (s || "").toString().trim().toLowerCase(); }

  function apply(){
    const idRaw = normalize(idEl.value);
    const name = normalize(nameEl.value);
    const role = normalize(roleEl.value);
    const training = normalize(trEl.value);

    if(idRaw && !/^[0-9]+$/.test(idRaw)){
      errEl.classList.remove("d-none");
    } else {
      errEl.classList.add("d-none");
    }

    rows.forEach(tr => {
      const id = normalize(tr.dataset.crewId);
      const nm = normalize(tr.dataset.crewName);
      const rl = normalize(tr.dataset.crewType);
      const trn = normalize(tr.dataset.crewTraining);

      let ok = true;
      if(idRaw && /^[0-9]+$/.test(idRaw)) ok = ok && (id === idRaw);
      if(name) ok = ok && nm.includes(name);
      if(role) ok = ok && (rl === role);
      if(training) ok = ok && (trn === training);

      tr.style.display = ok ? "" : "none";
    });
  }

  function clear(){
    idEl.value = "";
    nameEl.value = "";
    roleEl.value = "";
    trEl.value = "";
    errEl.classList.add("d-none");
    rows.forEach(tr => tr.style.display = "");
  }

  idEl.addEventListener("input", apply);
  nameEl.addEventListener("input", apply);
  roleEl.addEventListener("change", apply);
  trEl.addEventListener("change", apply);
  document.getElementById("flt-crew-clear").addEventListener("click", clear);
})();
</script>

{% endblock %}
