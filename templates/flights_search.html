{% extends "base.html" %}
{% block content %}

<div class="row justify-content-center">
  <div class="col-12">
    <div class="card">
      <div class="card-body p-3 p-md-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-3">
          <div>
            <h2 class="mb-1">Open flights for sale</h2>
            <div class="text-muted">Enter route and date to see real-time availability.</div>
          </div>
          <a class="btn btn-outline-secondary" href="{{ url_for('guest_lookup') }}"><i class="bi bi-ticket-perforated me-1"></i>Manage booking</a>
        </div>

        <form method="get" action="{{ url_for('flights_search') }}" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">From</label>
            <div class="airport-combo">
              <input class="form-control airport-input" name="origin" id="origin" data-selected="{{ origin or '' }}" value="{{ origin or '' }}" placeholder="Choose origin airport" autocomplete="off" required>
              <div class="airport-menu list-group" id="origin_menu"></div>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">To</label>
            <div class="airport-combo">
              <input class="form-control airport-input" name="dest" id="dest" data-selected="{{ dest or '' }}" value="{{ dest or '' }}" placeholder="Select origin first" autocomplete="off" required>
              <div class="airport-menu list-group" id="dest_menu"></div>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Departure date</label>
            <input class="form-control" name="dep_date" id="dep_date" data-selected="{{ dep_date or '' }}" value="{{ dep_date or '' }}" placeholder="Select a date" readonly required>
            <div class="form-text" id="date_hint">Choose a destination to see available dates.</div>
          </div>
          <div class="col-12 d-flex flex-wrap gap-2">
            <button class="btn btn-primary" id="search_btn"><i class="bi bi-filter me-1"></i>Apply filters</button>
<a class="btn btn-outline-secondary" href="{{ url_for('index') }}"><i class="bi bi-house me-1"></i>Back to home</a>
          </div>
        </form>

        <hr class="my-4">

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-2">
          <div>
            <h5 class="mb-1">Open flights for sale</h5>
            <div class="text-muted">Showing Active flights with available seats from today onwards. Use the filters above to narrow the list.</div>
          </div>
        </div>

        {% if flights %}
          <div class="table-responsive">
            <table class="table table-hover align-middle flights-open-table">
              <thead>
                <tr>
                  <th>Flight</th>
                  <th>Date</th>
                  <th>Departure</th>
                  <th>Route</th>
                  <th class="text-end">Regular ($)</th>
                  <th class="text-end">First ($)</th>
                  <th class="text-end">Available seats</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for f in flights %}
                {# Safety: hide flights with no available seats #}
                {% if (f.available_tickets|int) > 0 %}
                <tr>
                  <td class="fw-semibold">{{ f.ID }}</td>
                  <td>{{ f.Date_of_departure }}</td>
                  <td>{{ f.Time_of_departure|hm }}</td>
                  <td>{{ f.Origin_airport }} → {{ f.Arrival_airport }}</td>
                  <td class="text-end">{{ "$%.2f"|format(f.price_regular|float) if f.price_regular is not none else "—" }}</td>
                  <td class="text-end">{{ "$%.2f"|format(f.price_first|float) if f.price_first is not none else "—" }}</td>
                  <td class="text-end">{{ f.available_tickets }}</td>
                  <td class="text-end">
                    {% if session_role != "manager" %}
                    <a class="btn btn-sm btn-primary" href="{{ url_for('flight_book', flight_id=f.ID) }}">
                      <i class="bi bi-airplane me-1"></i>Book
                    </a>
                    {% endif %}
                  </td>
                </tr>
                {% endif %}
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-info mb-0">
            No open flights match the selected filters.
          </div>
        {% endif %}

      </div>
    </div>
  </div>
</div>

{% endblock %}
